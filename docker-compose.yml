version: "3.9"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    env_file:
      - ./backend/.env
    environment:
      PORT: 3000
      FRONTEND_URL: ${FRONTEND_URL:-https://pokerscrum.ru/}
    ports:
      - "127.0.0.1:3000:3000"
    # Для доступа к MySQL на хосте используем IP Docker bridge
    extra_hosts:
      - "host.docker.internal:host-gateway"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        API_BASE: ${API_BASE:-https://pokerscrum.ru/}
        WS_BASE: ${WS_BASE:-ws://pokerscrum.ru/}
        # Nuxt требует префикс NUXT_PUBLIC_ для переменных в public runtimeConfig
        NUXT_PUBLIC_API_BASE: ${API_BASE:-https://pokerscrum.ru/}
        NUXT_PUBLIC_WS_BASE: ${WS_BASE:-ws://pokerscrum.ru/}
    restart: always
    env_file:
      - ./frontend/.env
    environment:
      PORT: 3001
      NITRO_PORT: 3001
      # Для production используем полный URL через nginx (работает и в браузере, и в SSR)
      # В коде уже добавляется /api, поэтому здесь только базовый путь
      API_BASE: ${API_BASE:-https://pokerscrum.ru/}
      # WebSocket требует полный URL (без /ws, он добавляется в коде)
      WS_BASE: ${WS_BASE:-ws://pokerscrum.ru/}
    ports:
      - "127.0.0.1:3001:3001"
